# Static information for this action template
# Source: https://github.com/GitTools/actions
# Note: Make sure the checkout action is called with:  fetch-depth: 0
# This action builds a static website from markdown using docusaurus. See: https://docusaurus.io/
name: "Build docusaurus site"
description: "Build a static website (e.g. blog) using Docusaurus"

# Inputs (parameters) for this action
inputs:
  docsDir:
    description: The directory where the docusaurus docs are stored in the generated website, default is 'docs'.
    required: false
    default: ''
  staticDir:
    description: The directory where the docusaurus static files are stored in the generated website, default is 'static'.
    required: false
    default: ''
  blogDir:
    description: The directory where the docusaurus blog files are stored in the generated website, default is 'blog'.
    required: false
    default: ''
  targetDir:
    description: The directory to store the generated docusaurus website in. Default is ./publish .
    required: true
    default: '${{ github.workspace }}/publish'
  # KingTech template parameters
  siteName:
    description: The name of your site.
    required: false
    default: 'my-website'
  projectName:
    description: The name of your project, used for example in the navbar. Default is the same as siteName.
    required: false
    default: ''
  url:
    description: The URL of the site, e.g. 'https://www.my-site.com'. Default is 'https://www.kingtech.nl'.
    required: false
    default: 'https://www.kingtech.nl'
  baseUrl:
    description: The base URL of the site, e.g. '/my-project/' if the site is hosted on a subpath. Default is '/'.
    required: false
    default: '/'
  # Docusaurus build parameters
  docusaurusVersion:
    description: Optionally a docusaurus version can be specified for the markdown. 
    required: false
    default: 'latest'
  docusaurusVariant:
    description: The docusaurus template variant to use (javascript or typescript), default is javascript.
    required: false
    default: 'javascript'
  docusaurusTemplate:
    description: The docusaurus template to use, default is 'classic'.
    required: false
    default: 'classic'
  # Dependencies
  npmCache:
    description: Optionally specify the npm cache directory to speed up npm install.
    required: false
    default: ''
  nodeVersion:
    description: Optionally specify the node version to use, default is 'latest'.
    required: false
    default: 'latest'

runs:
  using: "composite"
  steps:

  # Move to docusaurus action directory
  - name: Make sure docusaurus path exists
    shell: bash
    run: |
      export ORIGINAL_DIR=$(pwd)
      echo "ORIGINAL_DIR=$ORIGINAL_DIR" >> $GITHUB_ENV
      echo "storing original dir $ORIGINAL_DIR for later use"
      echo "creating docusaurus action path: ${{ github.action_path }}/docusaurus"
      mkdir -p "${{ github.action_path }}/docusaurus"

  # Install node.js
  - name: Setup node.js from cache
    uses: actions/setup-node@v6
    if: ${{ inputs.npmCache != '' }}
    with:
      node-version: '${{ inputs.nodeVersion }}'
      cache: 'npm'
      cache-dependency-path: "${{ inputs.npmCache }}"
  - name: Setup node.js without cache
    uses: actions/setup-node@v6
    if: ${{ inputs.npmCache == '' }}
    with:
      node-version: '${{ inputs.nodeVersion }}'

  # Create basic docusaurus site
  - name: Setup docusaurus site
    shell: bash
    working-directory: ${{ github.action_path }}/docusaurus
    run: |
      ### Install docusaurus.
      npm install create-docusaurus@3.9.2
      ### Setup docusaurus site (base).
      ### npx create-docusaurus@latest my-website classic
      echo 'building docusaurus site'
      npx create-docusaurus@${{ inputs.docusaurusVersion }} "${{ inputs.siteName }}" ${{ inputs.docusaurusTemplate }} --${{ inputs.docusaurusVariant }}

  # Remove default docusaurus content (e.g. blog, docs, static) to prevent it from being included in the generated website.
  - name: Customize docusaurus site
    shell: bash
    working-directory: ${{ github.action_path }}/docusaurus
    run: |    
      echo "Removing build folder"
      rm -rf "${{ inputs.siteName }}/build"

      if [ ${{ inputs.staticDir }} != '' ]; then
        echo "Replacing static folder"
        rm -rf "${{ inputs.siteName }}/static/*"
        cp -r "${{ inputs.staticDir }}/*" "./${{ inputs.siteName }}/static/"
      elif [ -d "${{ github.workspace }}/static" ]; then
        echo "Removing default static folder"
        rm -rf "${{ inputs.siteName }}/static"
        cp -r "${{ github.workspace }}/static/*" "./${{ inputs.siteName }}/static/"
      fi

      if [ ${{ inputs.docsDir }} != '' ]; then
        echo "Replacing docs folder"
        rm -rf "${{ inputs.siteName }}/docs/*"
        cp -r "${{ inputs.docsDir }}/*" "./${{ inputs.siteName }}/docs/"
      elif [ -d "${{ github.workspace }}/docs" ]; then
        echo "Removing default docs folder"
        rm -rf "${{ inputs.siteName }}/docs"
        tree "${{ github.workspace }}/docs"
        cp -a "${{ github.workspace }}/docs/." "./${{ inputs.siteName }}/docs/"
      fi

      if [ ${{ inputs.blogDir }} != '' ]; then
        echo "Replacing blog folder"
        rm -rf "${{ inputs.siteName }}/blog/*"
        cp -r "${{ inputs.blogDir }}/*" "./${{ inputs.siteName }}/blog/"
      elif [ -d "${{ github.workspace }}/blog" ]; then
        echo "Removing default blog folder"
        rm -rf "${{ inputs.siteName }}/blog"
        cp -r "${{ github.workspace }}/blog/*" "./${{ inputs.siteName }}/blog/"
      fi

      #cd "${{ env.ORIGINAL_DIR }}"
      #cp -r "${{ inputs.sourceDir }}" "${{ github.action_path }}/docusaurus/${{ inputs.siteName }}"

  - name: Build docusaurus site
    shell: bash
    working-directory: ${{ github.action_path }}/docusaurus/${{ inputs.siteName }}
    run: |      
      ### Build docusaurus site.
      echo "Building docusaurus site"
      npm run build

  - name: Store output in target directory
    shell: bash
    run: |      
      echo "Storing output in target directory: ${{ inputs.targetDir }}"
      cp -r "${{ github.action_path }}/docusaurus/${{ inputs.siteName }}/build" "${{ inputs.targetDir }}/"